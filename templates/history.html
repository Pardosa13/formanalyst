{% extends "base.html" %}

{% block title %}Analysis History - The Form Analyst{% endblock %}

{% block extra_css %}
<style>
    .history-header {
        background: linear-gradient(135deg, #11998e, #38ef7d);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .history-header h1 {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .history-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .history-table .table {
        margin-bottom: 0;
    }
    
    .history-table thead {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }
    
    .history-table tbody tr {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .history-table tbody tr:hover {
        background: rgba(52, 152, 219, 0.05);
        transform: scale(1.01);
    }
    
    .meeting-name {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .confidence-badge {
        font-weight: 500;
        padding: 0.4rem 0.8rem;
    }
    
    .action-buttons .btn {
        padding: 0.25rem 0.75rem;
        margin: 0 0.25rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #e0e0e0;
        margin-bottom: 1rem;
    }
    
    .empty-state h3 {
        color: var(--secondary-color);
        margin-bottom: 1rem;
    }
    
    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-mini {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .stat-mini h4 {
        margin-bottom: 0.25rem;
        color: var(--primary-color);
    }
    
    .stat-mini p {
        margin: 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .sort-icon {
        opacity: 0.3;
        transition: opacity 0.3s;
    }
    
    .sort-icon.active {
        opacity: 1;
    }
    
    .pagination {
        margin-top: 2rem;
        justify-content: center;
    }
    
    .page-link {
        border-radius: 10px;
        margin: 0 0.25rem;
        color: var(--primary-color);
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .page-link:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }
    
    .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- History Header -->
<div class="history-header">
    <h1><i class="bi bi-clock-history"></i> Analysis History</h1>
    <p>View and manage all your past race meeting analyses</p>
</div>

<!-- Statistics Summary -->
{% if meetings %}
<div class="stats-summary">
    <div class="stat-mini">
        <h4>{{ meetings|length }}</h4>
        <p>Total Analyses</p>
    </div>
    <div class="stat-mini">
        <h4>{{ meetings|sum(attribute='total_races', default=0) }}</h4>
        <p>Races Analyzed</p>
    </div>
    <div class="stat-mini">
        <h4>{{ meetings|sum(attribute='analyzed_horses', default=0) }}</h4>
        <p>Horses Evaluated</p>
    </div>
    <div class="stat-mini">
        <h4>{{ (meetings|selectattr('confidence_level', 'equalto', 'High')|list|length / meetings|length * 100)|round|int if meetings else 0 }}%</h4>
        <p>High Confidence</p>
    </div>
</div>
{% endif %}

<!-- Filter Section -->
<div class="filter-section">
    <div class="row align-items-end">
        <div class="col-md-3">
            <label for="searchInput" class="form-label">
                <i class="bi bi-search"></i> Search Meetings
            </label>
            <input type="text" class="form-control" id="searchInput" placeholder="Type to search...">
        </div>
        <div class="col-md-2">
            <label for="confidenceFilter" class="form-label">Confidence Level</label>
            <select class="form-select" id="confidenceFilter">
                <option value="">All Levels</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="dateFilter" class="form-label">Date Range</label>
            <select class="form-select" id="dateFilter">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="sortBy" class="form-label">Sort By</label>
            <select class="form-select" id="sortBy">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="races">Most Races</option>
                <option value="horses">Most Horses</option>
            </select>
        </div>
        <div class="col-md-3 text-end">
            <button class="btn btn-outline-secondary" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
    </div>
</div>

<!-- Meetings Table or Empty State -->
{% if meetings %}
<div class="history-table">
    <table class="table table-hover align-middle" id="meetingsTable">
        <thead>
            <tr>
                <th>Meeting Name <i class="bi bi-arrow-down-up sort-icon"></i></th>
                <th>Date/Time <i class="bi bi-arrow-down-up sort-icon"></i></th>
                <th>Track</th>
                <th>Races</th>
                <th>Horses</th>
                <th>Confidence</th>
                <th>Mode</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for meeting in meetings %}
            <tr data-meeting-id="{{ meeting.id }}" 
                data-date="{{ meeting.uploaded_at.isoformat() }}"
                data-confidence="{{ meeting.confidence_level }}">
                <td class="meeting-name">
                    {{ meeting.meeting_name[:40] }}{% if meeting.meeting_name|length > 40 %}...{% endif %}
                </td>
                <td>
                    <i class="bi bi-calendar2 text-muted"></i> 
                    {{ meeting.uploaded_at.strftime('%b %d, %Y') }}<br>
                    <small class="text-muted">{{ meeting.uploaded_at.strftime('%I:%M %p') }}</small>
                </td>
                <td>
                    <span class="badge bg-secondary">{{ meeting.track_condition }}</span>
                </td>
                <td>
                    <i class="bi bi-flag text-primary"></i> {{ meeting.total_races }}
                </td>
                <td>
                    <i class="bi bi-trophy text-success"></i> {{ meeting.analyzed_horses }}
                </td>
                <td>
                    <span class="confidence-badge badge bg-{{ 'success' if meeting.confidence_level == 'High' else 'warning' if meeting.confidence_level == 'Medium' else 'danger' }}">
                        {{ meeting.confidence_level }}
                    </span>
                </td>
                <td>
                    {% if meeting.advanced_mode %}
                        <span class="badge bg-info">Advanced</span>
                    {% else %}
                        <span class="badge bg-light text-dark">Standard</span>
                    {% endif %}
                </td>
                <td class="text-center action-buttons">
                    <a href="{{ url_for('view_meeting', meeting_id=meeting.id) }}" 
                       class="btn btn-sm btn-primary" title="View Analysis">
                        <i class="bi bi-eye"></i>
                    </a>
                    <button class="btn btn-sm btn-info" onclick="shareMeeting({{ meeting.id }})" title="Share">
                        <i class="bi bi-share"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteMeeting({{ meeting.id }})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination (if needed for many results) -->
{% if meetings|length > 10 %}
<nav>
    <ul class="pagination" id="pagination">
        <!-- Pagination will be generated by JavaScript -->
    </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="empty-state">
    <i class="bi bi-inbox"></i>
    <h3>No Analyses Yet</h3>
    <p class="text-muted">Upload your first CSV file to start analyzing race meetings</p>
    <a href="{{ url_for('dashboard') }}" class="btn btn-primary mt-3">
        <i class="bi bi-upload"></i> Upload First File
    </a>
</div>
{% endif %}

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-share"></i> Share Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Share this analysis link:</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="shareLink" readonly>
                    <button class="btn btn-outline-secondary" onclick="copyLink()">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> 
                    Note: Shared links are view-only and expire after 7 days.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('confidenceFilter').addEventListener('change', filterTable);
    document.getElementById('dateFilter').addEventListener('change', filterTable);
    document.getElementById('sortBy').addEventListener('change', sortTable);
    
    function filterTable() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const confidenceFilter = document.getElementById('confidenceFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const rows = document.querySelectorAll('#meetingsTable tbody tr');
        
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        rows.forEach(row => {
            const meetingName = row.querySelector('.meeting-name').textContent.toLowerCase();
            const confidence = row.dataset.confidence;
            const meetingDate = new Date(row.dataset.date);
            
            let showRow = true;
            
            // Search filter
            if (searchValue && !meetingName.includes(searchValue)) {
                showRow = false;
            }
            
            // Confidence filter
            if (confidenceFilter && confidence !== confidenceFilter) {
                showRow = false;
            }
            
            // Date filter
            if (dateFilter) {
                if (dateFilter === 'today' && meetingDate < today) showRow = false;
                if (dateFilter === 'week' && meetingDate < weekAgo) showRow = false;
                if (dateFilter === 'month' && meetingDate < monthAgo) showRow = false;
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
    
    function sortTable() {
        const sortBy = document.getElementById('sortBy').value;
        const tbody = document.querySelector('#meetingsTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            switch(sortBy) {
                case 'date-asc':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'date-desc':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'races':
                    return parseInt(b.querySelector('td:nth-child(4)').textContent) - 
                           parseInt(a.querySelector('td:nth-child(4)').textContent);
                case 'horses':
                    return parseInt(b.querySelector('td:nth-child(5)').textContent) - 
                           parseInt(a.querySelector('td:nth-child(5)').textContent);
                default:
                    return 0;
            }
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('confidenceFilter').value = '';
        document.getElementById('dateFilter').value = '';
        document.getElementById('sortBy').value = 'date-desc';
        filterTable();
        sortTable();
    }
    
    function deleteMeeting(meetingId) {
        if (confirm('Are you sure you want to delete this analysis? This cannot be undone.')) {
            // In production, make an AJAX call to delete
            const row = document.querySelector(`tr[data-meeting-id="${meetingId}"]`);
            row.style.transition = 'opacity 0.3s';
            row.style.opacity = '0';
            setTimeout(() => row.remove(), 300);
        }
    }
    
    function shareMeeting(meetingId) {
        const shareLink = `${window.location.origin}/shared/meeting/${meetingId}`;
        document.getElementById('shareLink').value = shareLink;
        new bootstrap.Modal(document.getElementById('shareModal')).show();
    }
    
    function copyLink() {
        const shareLink = document.getElementById('shareLink');
        shareLink.select();
        document.execCommand('copy');
        
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }
    
    function exportData() {
        // In production, generate actual CSV export
        alert('Exporting analysis history to CSV...');
    }
    
    // Click row to view meeting
    document.querySelectorAll('#meetingsTable tbody tr').forEach(row => {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.action-buttons')) {
                const meetingId = this.dataset.meetingId;
                window.location.href = `/view_meeting/${meetingId}`;
            }
        });
    });
</script>
{% endblock %}
