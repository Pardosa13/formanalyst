{% extends "base.html" %}

{% block title %}{{ meeting.meeting_name }} - Analysis Results{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Meeting Header -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2>{{ meeting.meeting_name }}</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>Uploaded:</strong> {{ meeting.uploaded_at.strftime('%Y-%m-%d %H:%M') }}
                </div>
                <div class="col-md-3">
                    <strong>Track Condition:</strong> {{ meeting.track_condition }}
                </div>
                <div class="col-md-3">
                    <strong>Total Races:</strong> {{ meeting.total_races }}
                </div>
                <div class="col-md-3">
                    <strong>Confidence Level:</strong> 
                    <span class="badge bg-{% if meeting.confidence_level == 'High' %}success{% elif meeting.confidence_level == 'Medium' %}warning{% else %}danger{% endif %}">
                        {{ meeting.confidence_level }}
                    </span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Analyzed Horses:</strong> {{ meeting.analyzed_horses }}
                </div>
                <div class="col-md-6">
                    <strong>Advanced Mode:</strong> {{ "Yes" if meeting.advanced_mode else "No" }}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="mb-3">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        <a href="{{ url_for('history') }}" class="btn btn-info">View History</a>
        <button onclick="window.print()" class="btn btn-primary">Print Report</button>
    </div>

    <!-- Races -->
    {% for race in meeting.races %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h4>Race {{ race.race_number }}: {{ race.race_name }}</h4>
            <div class="row">
                <div class="col-md-6">Distance: {{ race.distance }}</div>
                <div class="col-md-6">Prize Money: {{ race.prize_money }}</div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Horse</th>
                            <th>Barrier</th>
                            <th>Weight</th>
                            <th>Jockey</th>
                            <th>Trainer</th>
                            <th>Form</th>
                            <th>Speed</th>
                            <th>Class</th>
                            <th>Win %</th>
                            <th>Place %</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for horse in race.horses %}
                        <tr class="{% if loop.index <= 3 %}table-success{% endif %}">
                            <td>{{ horse.number }}</td>
                            <td><strong>{{ horse.name }}</strong></td>
                            <td>{{ horse.barrier }}</td>
                            <td>{{ horse.weight }}kg</td>
                            <td>{{ horse.jockey }}</td>
                            <td>{{ horse.trainer }}</td>
                            <td>{{ horse.last_5_starts }}</td>
                            <td>{{ horse.speed_rating }}</td>
                            <td>{{ horse.class_rating }}</td>
                            <td>
                                <span class="badge bg-{% if horse.win_probability > 20 %}success{% elif horse.win_probability > 10 %}warning{% else %}secondary{% endif %}">
                                    {{ horse.win_probability }}%
                                </span>
                            </td>
                            <td>{{ horse.place_probability }}%</td>
                            <td>
                                <span class="badge bg-{% if horse.recommended_bet == 'Win' %}success{% elif horse.recommended_bet == 'Each Way' %}info{% elif horse.recommended_bet == 'Place' %}primary{% else %}secondary{% endif %}">
                                    {{ horse.recommended_bet }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Top Picks Summary -->
            <div class="alert alert-info mt-3">
                <strong>Quick Picks for Race {{ race.race_number }}:</strong>
                <ul class="mb-0">
                    <li>Win: {{ race.horses[0].name }} ({{ race.horses[0].win_probability }}%)</li>
                    <li>Place: {{ race.horses[0].name }}, {{ race.horses[1].name }}</li>
                    <li>Each Way: {{ race.horses[1].name }} ({{ race.horses[1].win_probability }}%)</li>
                </ul>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Summary Section -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4>Meeting Summary</h4>
        </div>
        <div class="card-body">
            <p><strong>Analysis Complete:</strong> All {{ meeting.total_races }} races have been analyzed with {{ meeting.analyzed_horses }} horses processed.</p>
            <p><strong>Overall Confidence:</strong> {{ meeting.confidence_level }}</p>
            <p><strong>Track Conditions:</strong> {{ meeting.track_condition }} - adjustments have been made to calculations accordingly.</p>
        </div>
    </div>
</div>

<style>
    @media print {
        .btn { display: none; }
        .card { break-inside: avoid; }
    }
</style>
{% endblock %}
